<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registro de Turnos - Lince Seguridad Cooperativa</title>
    
    <style>
        /* üé® ESTILOS CSS */
        body {
            background-color: #000000;
            color: #ffffff;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
        }

        .contenedor {
            max-width: 1000px;
            margin: 0 auto;
            padding: 25px;
            border: 1px solid #1a1a1a;
            border-radius: 10px;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }

        h1 {
            text-align: center;
            color: #FFA500; 
            margin-bottom: 30px;
        }

        h2 {
            border-bottom: 2px solid #444444;
            padding-bottom: 5px;
            margin-top: 25px;
            color: #dddddd;
        }

        .grid-campos {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }
        
        .grid-turno {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .grid-horas-calc {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }

        input[type="text"], input[type="number"], input[type="date"], input[type="time"], select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #555555;
            border-radius: 5px;
            background-color: #222222; 
            color: #ffffff; 
            font-size: 1em;
        }

        input[readonly] {
            background-color: #333333; 
            font-weight: bold;
            color: #88ff88; 
        }
        
        button {
            background-color: #007bff; 
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 1.1em;
            transition: background-color 0.3s;
            margin-top: 15px;
        }

        button:hover {
            background-color: #0056b3;
        }
        
        #btn-reporte {
            background-color: #f4a261;
            width: 100%;
            margin-top: 15px;
        }
        #btn-reporte:hover {
            background-color: #e76f51;
        }

        #resumen-total {
            background-color: #444444; 
            padding: 20px;
            margin-top: 30px;
            border-radius: 8px;
            border: 2px solid #555555;
        }

        #resumen-diario {
            max-height: 300px;
            overflow-y: auto; 
            padding: 10px;
            background-color: #555555;
            border-radius: 5px;
            margin-bottom: 15px;
        }
        
        .registro-dia {
            padding: 8px 0;
            border-bottom: 1px dashed #777777;
        }
        
        .registro-dia:last-child {
            border-bottom: none;
        }

        #horas-totales {
            font-size: 2em;
            font-weight: bold;
            color: #FFA500; 
            display: block;
            text-align: right;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="contenedor">
        <h1>üõ°Ô∏è Lince Seguridad Cooperativa de Trabajo</h1>
        
        <div class="campo-asociado">
            <h2>Datos del Asociado</h2>
            <div class="grid-campos">
                <div>
                    <label for="numero-socio">N√∫mero de Socio:</label>
                    <input type="number" id="numero-socio" required>
                </div>
                <div>
                    <label for="nombre-completo">Nombre y Apellido Completo:</label>
                    <input type="text" id="nombre-completo" required>
                </div>
                <div>
                    <label for="categoria">Categor√≠a:</label>
                    <select id="categoria" required>
                        <option value="vigilador">Vigilador</option>
                        <option value="protector">Protector</option>
                        <option value="jefe-10">Jefe de Turno (10 a√±os)</option>
                        <option value="jefe-15">Jefe de Turno (15 a√±os)</option>
                        <option value="jefe-servicio">Jefe de Servicio</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="campo-turno">
            <h2>Carga de Turno Diario</h2>
            
            <div class="grid-turno">
                <div>
                    <label for="fecha-turno">Fecha:</label>
                    <input type="date" id="fecha-turno" required> 
                </div>
                <div>
                    <label for="objetivo">Objetivo:</label>
                    <select id="objetivo" required>
                        <option value="moreno-502-palacio-raggio">Moreno 502 PALACIO RAGGIO</option>
                        <option value="garay-744-san-telmo">Av. Juan Garay 744 San Telmo Quartier</option>
                    </select>
                </div>
            </div>

            <div class="grid-horas-calc">
                <div>
                    <label for="hora-inicio">Comienzo de Guardia (HH:MM):</label>
                    <input type="time" id="hora-inicio" required>
                </div>
                <div>
                    <label for="hora-fin">Finalizaci√≥n de Guardia (HH:MM):</label>
                    <input type="time" id="hora-fin" required>
                </div>
                <div>
                    <label for="horas-dia-calc">Horas Trabajadas (Suma Autom√°tica):</label>
                    <input type="text" id="horas-dia-calc" readonly value="0h 0m">
                </div>
            </div>

            <button onclick="registrarTurno()">‚ûï Registrar Turno del D√≠a</button>
        </div>

        <div id="resumen-total">
            <h2>Resumen Mensual de Horas</h2>
            
            <div id="resumen-diario">
                <p style="color: #cccccc;">A√∫n no hay registros de turnos.</p>
            </div>
            
            <hr style="border-color: #777777;">
            
            <label style="margin-bottom: 0;">**TOTAL DE HORAS TRABAJADAS EN EL MES**</label>
            <span id="horas-totales">0h 0m</span>

            <button id="btn-reporte" onclick="generarReporteEmail()">üìß Generar Reporte (FormSubmit)</button>
        </div>
    </div>

    <script>
        let registrosTurnos = [];

        // --- FUNCI√ìN DE C√ÅLCULO DE HORAS (CORREGIDA) ---
        function calcularHoras(inicio, fin) {
            if (!inicio || !fin) return { totalMinutos: 0, formato: "0h 0m" };

            // Convertir HH:MM a minutos totales desde la medianoche
            const [hInicio, mInicio] = inicio.split(':').map(Number);
            const [hFin, mFin] = fin.split(':').map(Number);

            let minutosInicio = (hInicio * 60) + mInicio;
            let minutosFin = (hFin * 60) + mFin;
            
            let diferenciaMinutos;
            const minutosDiaCompleto = 24 * 60; // 1440 minutos

            // L√≥gica CORREGIDA para turnos que cruzan la medianoche (Noche/D√≠a siguiente)
            if (minutosFin <= minutosInicio) {
                // La hora de fin es menor, por lo tanto el turno cruza.
                // Ej: Inicio 22:00 (1320) a Fin 06:00 (360)
                // Diferencia = (Fin + 1440) - Inicio
                diferenciaMinutos = (minutosFin + minutosDiaCompleto) - minutosInicio;
            } else {
                // Turno normal dentro del mismo d√≠a
                diferenciaMinutos = minutosFin - minutosInicio;
            }
            
            // Validaci√≥n b√°sica para evitar valores negativos o absurdos (m√°s de 24h)
            if (diferenciaMinutos <= 0 || diferenciaMinutos > minutosDiaCompleto) {
                return { totalMinutos: 0, formato: "Error en Hora" };
            }

            const horas = Math.floor(diferenciaMinutos / 60);
            const minutos = diferenciaMinutos % 60;
            
            return { 
                totalMinutos: diferenciaMinutos, 
                formato: `${horas}h ${minutos}m` 
            };
        }

        document.getElementById('hora-fin').addEventListener('change', function() {
            const inicio = document.getElementById('hora-inicio').value;
            const fin = this.value;
            const resultado = calcularHoras(inicio, fin);
            document.getElementById('horas-dia-calc').value = resultado.formato;
        });

        function registrarTurno() {
            const fecha = document.getElementById('fecha-turno').value;
            const selectObjetivo = document.getElementById('objetivo');
            const objetivo = selectObjetivo.options[selectObjetivo.selectedIndex].text; 
            const inicio = document.getElementById('hora-inicio').value;
            const fin = document.getElementById('hora-fin').value;

            if (!fecha || !inicio || !fin) {
                alert('‚ö†Ô∏è Por favor, complete la fecha, objetivo, hora de inicio y hora de fin para registrar el turno.');
                return;
            }

            const horasCalculadas = calcularHoras(inicio, fin);

            if (horasCalculadas.totalMinutos <= 0) {
                 alert('‚ö†Ô∏è La hora de inicio es igual o posterior a la hora de fin. Verifique el horario. El c√°lculo result√≥ en 0 horas.');
                 return;
            }
            
            const indiceExistente = registrosTurnos.findIndex(reg => reg.fecha === fecha);

            // Se guardan los horarios de inicio y fin para el reporte detallado
            const nuevoRegistro = {
                fecha: fecha,
                objetivo: objetivo, 
                inicio: inicio, // ALMACENA INGRESO
                fin: fin,       // ALMACENA EGRESO
                horas: horasCalculadas.formato,
                minutosTotales: horasCalculadas.totalMinutos 
            };

            if (indiceExistente > -1) {
                registrosTurnos[indiceExistente] = nuevoRegistro;
                alert(`‚úÖ Turno del d√≠a ${fecha} actualizado a ${horasCalculadas.formato} en ${objetivo}.`);
            } else {
                registrosTurnos.push(nuevoRegistro);
                alert(`‚úÖ Turno del d√≠a ${fecha} registrado con ${horasCalculadas.formato} en ${objetivo}.`);
            }

            registrosTurnos.sort((a, b) => new Date(a.fecha) - new Date(b.fecha));
            
            actualizarResumen();
            
            document.getElementById('hora-inicio').value = '';
            document.getElementById('hora-fin').value = '';
            document.getElementById('horas-dia-calc').value = '0h 0m';
        }

        function actualizarResumen() {
            const contenedorDiario = document.getElementById('resumen-diario');
            const horasTotalesSpan = document.getElementById('horas-totales');
            let totalMinutosMes = 0; 

            registrosTurnos.forEach(registro => {
                totalMinutosMes += registro.minutosTotales;
            });

            let horasTotal = Math.floor(totalMinutosMes / 60);
            let minutosTotal = totalMinutosMes % 60;
            
            // --- L√ìGICA DE REDONDEO (A PARTIR DE 10 MINUTOS SE REDONDEA LA HORA) ---
            if (minutosTotal >= 10) {
                horasTotal += 1;
                minutosTotal = 0;
            }
            // -----------------------------------------------------------------------

            const totalFormato = `${horasTotal}h ${minutosTotal}m`;

            horasTotalesSpan.textContent = totalFormato;

            contenedorDiario.innerHTML = ''; 

            if (registrosTurnos.length === 0) {
                contenedorDiario.innerHTML = '<p style="color: #cccccc;">A√∫n no hay registros de turnos.</p>';
                return;
            }

            registrosTurnos.forEach(registro => {
                const elementoDia = document.createElement('div');
                elementoDia.classList.add('registro-dia');
                
                const fechaLegible = new Date(registro.fecha + 'T00:00:00').toLocaleDateString('es-AR', {
                    weekday: 'short', day: 'numeric', month: 'short'
                });

                elementoDia.innerHTML = `
                    <span style="font-weight: bold; color: #ffcc99;">${fechaLegible}:</span> 
                    <span style="color: #cccccc;">${registro.objetivo}</span> | 
                    **Entrada:** ${registro.inicio} | **Salida:** ${registro.fin} |
                    Horas: <span style="color: #88ff88; font-weight: bold;">${registro.horas}</span>
                `;
                contenedorDiario.appendChild(elementoDia);
            });
        }

        // --- FUNCI√ìN DE REPORTE CON FORMSUBMIT ---

        function generarReporteEmail() {
            if (registrosTurnos.length === 0) {
                alert('No hay turnos registrados para generar el reporte.');
                return;
            }

            const nombre = document.getElementById('nombre-completo').value || 'Asociado Desconocido';
            const socio = document.getElementById('numero-socio').value || 'N/A';
            const categoria = document.getElementById('categoria').options[document.getElementById('categoria').selectedIndex].text;
            
            // El total de horas ya estar√° redondeado gracias a actualizarResumen()
            const totalHorasRedondeado = document.getElementById('horas-totales').textContent; 
            
            // 1. Crear el cuerpo del reporte en formato de texto
            let reporteDetalle = '\n--- DETALLE DE TURNOS ---\n';
            registrosTurnos.forEach(registro => {
                const fechaLegible = new Date(registro.fecha + 'T00:00:00').toLocaleDateString('es-AR', {
                    day: 'numeric', month: 'short'
                });
                
                // INCLUYE HORARIOS ESPEC√çFICOS PARA EL SUPERVISOR
                reporteDetalle += `D√≠a ${fechaLegible} | Objetivo: ${registro.objetivo} | Ingreso: ${registro.inicio} | Egreso: ${registro.fin} | Horas Calculadas: ${registro.horas}\n`;
            });
            reporteDetalle += `\nTOTAL DE HORAS TRABAJADAS (Redondeado): ${totalHorasRedondeado}`;
            
            // 2. Crear un formulario din√°mico oculto para FormSubmit
            const form = document.createElement('form');
            
            // EMAIL DE DESTINO DEFINIDO POR EL USUARIO
            form.action = `https://formsubmit.co/dareeglas@gmail.com`; 
            form.method = 'POST';
            form.style.display = 'none'; // Lo ocultamos

            // 3. A√±adir los campos de datos (Inputs ocultos)
            
            // Asunto fijo para el correo
            const inputSubject = document.createElement('input');
            inputSubject.type = 'hidden';
            inputSubject.name = '_subject';
            inputSubject.value = `REPORTE MENSUAL: ${nombre} (Socio: ${socio})`;
            form.appendChild(inputSubject);
            
            // Datos del Asociado
            const inputNombre = document.createElement('input');
            inputNombre.type = 'hidden';
            inputNombre.name = '1_Asociado';
            inputNombre.value = nombre;
            form.appendChild(inputNombre);

            const inputSocio = document.createElement('input');
            inputSocio.type = 'hidden';
            inputSocio.name = '2_Socio';
            inputSocio.value = socio;
            form.appendChild(inputSocio);
            
            const inputCategoria = document.createElement('input');
            inputCategoria.type = 'hidden';
            inputCategoria.name = '3_Categoria';
            inputCategoria.value = categoria;
            form.appendChild(inputCategoria);

            // Detalle completo (como una gran textarea para FormSubmit)
            const inputDetalle = document.createElement('textarea');
            inputDetalle.name = '4_Reporte_Detallado';
            inputDetalle.value = reporteDetalle;
            form.appendChild(inputDetalle);

            // 4. Agregar el formulario al cuerpo del documento y enviarlo
            document.body.appendChild(form);
            
            // Aviso antes de la redirecci√≥n de FormSubmit
            alert('Procesando el env√≠o del reporte. FormSubmit te redirigir√° a una p√°gina de confirmaci√≥n. ¬°La aplicaci√≥n ha sido reiniciada para un nuevo mes de carga!');

            form.submit();
            
            // 5. Limpieza de campos (ocurre antes de la redirecci√≥n)
            registrosTurnos = []; 
            actualizarResumen();

            document.getElementById('numero-socio').value = '';
            document.getElementById('nombre-completo').value = '';
            document.getElementById('categoria').selectedIndex = 0; 
            
            document.body.removeChild(form); 
        }

    </script>
</body>
</html>